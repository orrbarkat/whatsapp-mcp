# WhatsApp MCP Server Environment Configuration
# Copy this file to .env and fill in your values

# Database Configuration
# =====================
# The WhatsApp MCP server supports independent configuration of two database concerns:
#
# 1. Messages Database (DATABASE_URL):
#    - Chat history, message content, media metadata
#    - Used by Python MCP server and Go bridge
#
# 2. Sessions Database (WHATSAPP_SESSION_DATABASE_URL):
#    - WhatsApp authentication, device keys, contacts
#    - Used only by Go bridge for whatsmeow session storage
#    - Falls back to DATABASE_URL if not set
#    - Defaults to SQLite: file:store/whatsapp.db if neither is set

# Option 1: Use default SQLite for both (no configuration needed)
# DATABASE_URL is not set = SQLite will be used automatically for both messages and sessions

# Option 2: Use PostgreSQL for messages only (sessions remain SQLite)
# DATABASE_URL=postgres://username:password@localhost:5432/database_name

# Option 3: Use Supabase for messages only (sessions remain SQLite)
# DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:5432/postgres?sslmode=require
# SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
# SUPABASE_KEY=YOUR_SERVICE_KEY

# Option 4: Use same database for both messages and sessions
# DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:5432/postgres?sslmode=require
# Note: Requires migration 010_create_whatsmeow_session_tables.sql for session tables

# Option 5: Separate databases for messages and sessions (recommended for production)
# DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:5432/postgres?sslmode=require
# WHATSAPP_SESSION_DATABASE_URL=postgresql://postgres:YOUR_PASSWORD@db.YOUR_PROJECT_REF.supabase.co:5432/postgres?sslmode=require
# Note: Both require respective migrations (000_create_bridge_tables.sql and 010_create_whatsmeow_session_tables.sql)

# Supported Combinations:
# | Messages DB        | Session DB         | Use Case                          |
# |--------------------|--------------------|---------------------------------|
# | SQLite             | SQLite             | Default local development       |
# | PostgreSQL/Supabase| PostgreSQL/Supabase| Production (shared database)    |
# | PostgreSQL/Supabase| PostgreSQL/Supabase| Production (separate databases) |
# | SQLite             | PostgreSQL/Supabase| Local messages, remote sessions |
# | PostgreSQL/Supabase| SQLite             | Remote messages, local sessions |

# Google Cloud Storage Configuration (Optional)
# ==============================================
# GCS is used for persistent WhatsApp session storage - SQLite sessions ONLY
# This allows session recovery across container restarts or deployments
#
# IMPORTANT: GCS backup is automatically DISABLED when using Postgres/Supabase for sessions
# - If WHATSAPP_SESSION_DATABASE_URL is set to Postgres, GCS upload/download is skipped
# - For Postgres sessions, use Supabase built-in backups or pg_dump instead
# - Bridge logs will show: "GCS session backup is only for SQLite, skipping"
#
# Prerequisites (for SQLite sessions only):
# 1. Create a GCS bucket for session storage
# 2. Set up Application Default Credentials (ADC):
#    - For local development: Run `gcloud auth application-default login`
#    - For GCE/Cloud Run: Use service account with appropriate IAM roles
#    - For other environments: Set GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account-key.json
# 3. Grant service account these IAM permissions on the bucket:
#    - storage.objects.create (for uploads)
#    - storage.objects.get (for downloads)
#    - storage.objects.delete (optional, for cleanup)
#
# Configuration:
# GCS_SESSION_BUCKET=your-bucket-name
# GCS_SESSION_OBJECT_NAME=whatsapp.db
#
# Alternative Backup for Postgres Sessions:
# - Use Supabase's built-in point-in-time recovery (PITR)
# - Use pg_dump for manual backups:
#   pg_dump "$WHATSAPP_SESSION_DATABASE_URL" > session_backup.sql
# - Configure automated backups in Supabase dashboard

# Remote Deployment Configuration
# ================================
# Configuration for deploying to Cloud Run or other remote environments

# MCP Transport Mode
# - "stdio": Standard input/output (for local development)
# - "sse": Server-Sent Events over HTTP (for remote deployments)
# - Default: "stdio" (local), "sse" (Docker/Cloud Run)
MCP_TRANSPORT=sse

# MCP Server Port
# - Port for SSE transport (HTTP server)
# - Cloud Run injects PORT environment variable (default 8080)
# - We use 3000 to match application configuration
# - Default: 3000
MCP_PORT=3000

# Bridge Configuration
# ====================
WHATSAPP_BRIDGE_URL=http://localhost:8080

# Health Check Endpoint
# - The /health endpoint is automatically available
# - Bypasses OAuth authentication for Cloud Run health probes
# - Returns 200 OK if server is running
# - No configuration needed

# Signal Handling
# - SIGTERM is handled automatically for graceful shutdown
# - Both Python server and Go bridge terminate within 10 seconds
# - Ensures clean shutdown on Cloud Run scale-down or deployment
# - No configuration needed

# OAuth 2.1 Authentication Configuration
# ====================================
# OAuth 2.1 authentication is required for:
# - Remote Cloud Run deployments
# - SSE transport with remote clients
# - Not required for local STDIO transport
#
# Authentication flow:
# 1. Client obtains Bearer token from Google Identity Platform
# 2. Token included in Authorization header for each request
# 3. Server validates JWT token signature and claims
# 4. Request processed if token is valid
#
# OAUTH_ENABLED: Enable/disable OAuth authentication
# - Set to "true" for production Cloud Run deployments
# - Set to "false" for local development with STDIO transport
# - Default: "false" (local development)
OAUTH_ENABLED=true

# GOOGLE_CLIENT_ID: OAuth 2.0 Client ID from Google Cloud Console
# - Obtain from: Google Cloud Console → APIs & Services → Credentials
# - Create OAuth 2.0 Client ID (Web application or Desktop app)
# - Format: xxxxx.apps.googleusercontent.com
# - Store in Secret Manager for Cloud Run: whatsapp-mcp-google-client-id
# - For Google ID tokens, this value is used for both signature verification and audience validation
GOOGLE_CLIENT_ID=123456789-abcdefghijklmnop.apps.googleusercontent.com

# Note: OAUTH_AUDIENCE is automatically set to equal GOOGLE_CLIENT_ID for Google ID tokens.
# Do not configure OAUTH_AUDIENCE separately unless using a non-Google OAuth provider.

# How to obtain OAuth credentials:
# 1. Go to Google Cloud Console (https://console.cloud.google.com)
# 2. Navigate to "APIs & Services" → "Credentials"
# 3. Click "Create Credentials" → "OAuth 2.0 Client ID"
# 4. Configure OAuth consent screen (if first time):
#    - User type: Internal (for organization) or External (public)
#    - App name: "WhatsApp MCP Server"
#    - Scopes: openid, email, profile (default)
# 5. Choose application type:
#    - "Web application" for browser-based OAuth flow
#    - "Desktop app" for CLI-based tools
# 6. Configure authorized redirect URIs (for web apps):
#    - http://localhost:8080/callback (local testing)
#    - https://your-app.com/callback (production)
# 7. Copy Client ID and store in Secret Manager
# 8. Set OAUTH_AUDIENCE to your Cloud Run service URL
#
# For Cloud Run deployment:
# - Store credentials in Secret Manager (not in .env file)
# - See gcp/env-template.yaml for deployment configuration
# - See gcp/README.md for detailed OAuth setup guide

# ==========================================
# MCP Client Configuration Examples
# ==========================================
# After deploying to Cloud Run, configure your MCP clients to connect remotely.
#
# Claude Desktop (macOS):
# Edit: ~/Library/Application Support/Claude/claude_desktop_config.json
#
# Claude Desktop (Windows):
# Edit: %APPDATA%\Claude\claude_desktop_config.json
#
# Cursor (macOS/Linux):
# Edit: ~/.cursor/mcp.json
#
# Cursor (Windows):
# Edit: %USERPROFILE%\.cursor\mcp.json
#
# Example configuration (JSON):
# {
#   "mcpServers": {
#     "whatsapp-remote": {
#       "transport": "sse",
#       "url": "https://whatsapp-mcp-xxxxx-uc.a.run.app/sse",
#       "headers": {
#         "Authorization": "Bearer YOUR_GOOGLE_ID_TOKEN"
#       }
#     }
#   }
# }
#
# Obtaining Google ID tokens (audience must equal your GOOGLE_CLIENT_ID):
# gcloud auth print-identity-token --audiences=YOUR_CLIENT_ID.apps.googleusercontent.com
#
# Token refresh:
# - Google ID tokens expire after 1 hour
# - Manually refresh by generating a new token and updating the config
# - Or implement automated token refresh script
#
# For local development (STDIO transport):
# {
#   "mcpServers": {
#     "whatsapp": {
#       "command": "uv",
#       "args": ["--directory", "/path/to/whatsapp-mcp-server", "run", "main.py"]
#     }
#   }
# }

# ==========================================
# Deployment References
# ==========================================
# Local Development:
# - See main README.md for installation and setup
# - Use STDIO transport with Claude Desktop or Cursor
#
# Cloud Run Deployment:
# - See README.md "Deploying to Google Cloud Platform (GCP)" section
# - See gcp/README.md for detailed Cloud Run guide
# - See gcp/env-template.yaml for environment variable reference
#
# Docker Deployment:
# - See README.md "Running in Docker" section
# - Use MCP_TRANSPORT=sse for containerized environments
# - Docker Compose profiles:
#   * Run app only (default SQLite): docker compose --profile app up
#   * Run with PostgreSQL: docker compose --profile app --profile db up
#   * The app profile is required for the whatsapp-mcp service
#   * The db profile is optional for the PostgreSQL service

# ==========================================
# Security Notes
# ==========================================
# IMPORTANT: Never commit sensitive credentials to version control
#
# For production deployments:
# - Store all secrets in Google Secret Manager
# - Use short-lived OAuth tokens (1 hour expiry)
# - Implement automatic token refresh
# - Enable audit logging for Secret Manager and Cloud Run
# - Rotate secrets regularly (OAuth: 90 days, Supabase: 180 days)
# - Grant minimal IAM roles to service accounts
# - Monitor access logs and set up security alerts
#
# For local development:
# - Keep .env file in .gitignore
# - Use environment-specific .env files (.env.dev, .env.prod)
# - Never share credentials via unsecured channels
