services:
  postgres:
    profiles: [db]
    image: postgres:15-alpine
    container_name: whatsapp-postgres
    environment:
      POSTGRES_DB: whatsapp
      POSTGRES_USER: whatsapp
      POSTGRES_PASSWORD: whatsapp_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U whatsapp"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  whatsapp-mcp:
    profiles: [app]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: whatsapp-mcp
    user: "1000:1000"
    volumes:
      # Mount SQLite database directory to persist data (used when DATABASE_URL is not set)
      - whatsapp_data:/app/whatsapp-bridge/store:rw
      # Mount a directory for QR code display
      - ./qr-codes:/app/qr-codes:rw
      # Temporary directories required for read-only filesystem
      - /tmp
      - whatsapp_cache:/home/mcpuser/.cache
    ports:
      # MCP server port
      - "3000:3000"
      # Bridge API port
      - "8080:8080"
    env_file:
      - .env
    environment:
      # MCP transport mode: 'stdio' (default for local) or 'sse' (recommended for Docker)
      - MCP_TRANSPORT=${MCP_TRANSPORT:-sse}
      # MCP server port for SSE transport
      - MCP_PORT=3000
      # Bridge API URL (localhost since both services are in same container)
      - WHATSAPP_BRIDGE_URL=http://localhost:8080
    # depends_on:
    #   postgres:
    #     condition: service_healthy
    restart: unless-stopped
    # Health check using the /health endpoint (same as Cloud Run)
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

volumes:
  whatsapp_data:
    driver: local
  postgres_data:
    driver: local
  whatsapp_cache:
    driver: local
